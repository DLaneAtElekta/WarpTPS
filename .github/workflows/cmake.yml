name: CMake Build

on:
  push:
    branches: [ master, main, feature/* ]
  pull_request:
    branches: [ master, main ]

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-2022

    strategy:
      matrix:
        configuration: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3

    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
      with:
        nuget-version: 'latest'

    - name: Restore NuGet packages for CMake configuration
      run: nuget restore packages.config -PackagesDirectory packages

    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DUSE_MFC=ON `
          -DCMAKE_BUILD_TYPE=${{ matrix.configuration }}

    - name: Restore NuGet packages for generated solution
      run: nuget restore ${{github.workspace}}/build/WarpTPS.sln

    - name: Build with CMake
      run: cmake --build ${{github.workspace}}/build --config ${{ matrix.configuration }} -j 4

    - name: List build artifacts
      run: |
        Write-Host "Build artifacts:"
        Get-ChildItem -Path ${{github.workspace}}/build/bin/${{ matrix.configuration }} -Recurse -File | Select-Object FullName
        Get-ChildItem -Path ${{github.workspace}}/build/lib/${{ matrix.configuration }} -Recurse -File | Select-Object FullName
      shell: pwsh

    - name: Upload WarpTPS executable
      if: matrix.configuration == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: WarpTPS-x64-${{ matrix.configuration }}
        path: |
          ${{github.workspace}}/build/bin/${{ matrix.configuration }}/WarpTPS.exe
          ${{github.workspace}}/build/lib/${{ matrix.configuration }}/WarpTpsLib.lib
        retention-days: 30

    - name: Run unit tests (if available)
      if: matrix.configuration == 'Debug'
      continue-on-error: true
      shell: pwsh
      run: |
        $testDll = "${{github.workspace}}/build/bin/${{ matrix.configuration }}/WarpTpsLibUnitTest.dll"
        if (Test-Path $testDll) {
          Write-Host "Running unit tests..."
          & vstest.console.exe $testDll
        } else {
          Write-Host "Test DLL not found: $testDll"
        }

  build-linux:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        build_type: [Debug, Release]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          libboost-dev \
          libboost-system-dev \
          libboost-date-time-dev \
          libboost-regex-dev \
          python3-dev \
          python3-pip

    - name: Install Python dependencies
      run: |
        pip3 install pybind11 numpy scikit-build-core

    - name: Configure CMake
      run: |
        PYBIND11_DIR=$(python3 -m pybind11 --cmakedir)
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_PYTHON_BINDINGS=ON \
          -Dpybind11_DIR=$PYBIND11_DIR

    - name: Build
      run: cmake --build ${{github.workspace}}/build -j$(nproc)

    - name: List build artifacts
      run: |
        echo "Build artifacts:"
        find ${{github.workspace}}/build/lib -type f

    - name: Test Python bindings
      run: |
        cp ${{github.workspace}}/build/lib/_warptps_core*.so ${{github.workspace}}/python/warptps/
        cd ${{github.workspace}}
        python3 -c "
        import sys
        sys.path.insert(0, 'python')
        import warptps
        import numpy as np
        print('Testing WarpTPS Python bindings...')
        print(f'Version: {warptps.version()}')
        tps = warptps.TPSTransform()
        tps.add_landmark_tuple((100, 100), (110, 110))
        tps.add_landmark_tuple((200, 100), (210, 120))
        print(f'Landmarks: {tps.get_landmark_count()}')
        img = np.zeros((300, 300, 3), dtype=np.uint8)
        warped = tps.warp(img, percent=1.0)
        print(f'Warped image shape: {warped.shape}')
        print('âœ“ All tests passed!')
        "

    - name: Upload Linux artifacts
      if: matrix.build_type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: WarpTpsLib-Linux-${{ matrix.build_type }}
        path: |
          ${{github.workspace}}/build/lib/libWarpTpsLib.a
          ${{github.workspace}}/build/lib/_warptps_core*.so
        retention-days: 30
